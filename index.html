<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBM - Relações Públicas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Script do Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a2533;
        }
        .glassmorphism {
            background: rgba(26, 37, 51, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2.3rem;
            top: 0.8rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #b91c1c;
            border: 2px solid #374151;
        }
        .timeline-line {
            position: absolute;
            left: -2rem;
            top: 0.8rem;
            bottom: 0;
            width: 2px;
            background-color: #374151;
            z-index: -1;
        }
        .timeline-item:last-child .timeline-line { display: none; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a2533; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .admin-only, .commander-only, .editor-only { display: none; }
        /* Estilo para o campo de upload de arquivo */
        input[type="file"]::file-selector-button {
            @apply px-3 py-1.5 bg-slate-600 text-gray-200 font-semibold border-0 rounded-md mr-4 cursor-pointer hover:bg-slate-700 transition-colors text-sm;
        }
    </style>
</head>
<body class="text-gray-200">

    <!-- Container Principal -->
    <div id="app" class="min-h-screen flex flex-col">
        <header class="sticky top-0 z-20 p-4 shadow-lg glassmorphism">
            <div class="container flex items-center justify-between mx-auto">
                <div id="home-button" class="flex items-center gap-3 cursor-pointer">
                    <img src="https://dncbnpzzsjqwyiecjlue.supabase.co/storage/v1/object/public/avatars/IMG_4342.png" alt="Logo CBM" class="h-16"> 
                    <h1 class="hidden text-xl font-bold text-gray-200 sm:block">Corpo de Bombeiros Militares - Relações Públicas</h1>
                </div>
                <div id="auth-area" class="flex items-center gap-4"></div>
            </div>
        </header>

        <main class="container p-4 mx-auto md:p-6 flex-grow">
            <!-- Visão do Dashboard -->
            <div id="dashboard-view">
                <div class="flex flex-col items-center justify-between gap-4 mb-6 md:flex-row">
                    <h2 class="text-2xl font-semibold">Fichas de Integrantes</h2>
                    <div class="flex items-center gap-2">
                         <button id="add-member-button" class="admin-only flex items-center gap-2 px-4 py-2 font-semibold text-white transition-colors bg-red-700 rounded-md hover:bg-red-800">
                            <i data-lucide="user-plus" class="w-5 h-5"></i> Adicionar Integrante
                        </button>
                        <button id="add-post-button" class="editor-only flex items-center gap-2 px-4 py-2 font-semibold text-white transition-colors bg-blue-600 rounded-md hover:bg-blue-700">
                            <i data-lucide="file-plus" class="w-5 h-5"></i> Criar Postagem
                        </button>
                    </div>
                </div>
                <div id="loader" class="flex justify-center items-center py-10">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-red-600"></i>
                </div>
                <div id="members-grid" class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5"></div>
            </div>

            <!-- Visão do Perfil -->
            <div id="profile-view" class="hidden"></div>
        </main>
        
        <footer class="text-center p-4 text-gray-500 text-sm">
            Desenvolvido por kaleb
        </footer>
    </div>
    
    <!-- Modais -->
    <div id="member-modal" class="fixed inset-0 z-30 flex items-center justify-center hidden p-4 bg-black bg-opacity-75">
        <div class="w-full max-w-lg p-6 overflow-y-auto rounded-lg shadow-xl max-h-screen glassmorphism">
            <h3 id="member-modal-title" class="mb-4 text-xl font-semibold text-red-600"></h3>
            <form id="member-form" class="space-y-4">
                <input type="hidden" id="member-id">
                <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                    <input type="text" id="member-name" placeholder="Nick (do Roblox)" class="w-full px-3 py-2 text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-600" required>
                    <select id="member-rank" class="w-full px-3 py-2 text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-600" required></select>
                    <input type="text" id="member-division" placeholder="Divisão (Ex: CBM, SAMU)" class="w-full px-3 py-2 text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-600" required>
                    <input type="text" id="member-tag" placeholder="TAG" class="w-full px-3 py-2 text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-600">
                    <input type="text" id="member-specialization" placeholder="Especialização" class="w-full px-3 py-2 text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-600">
                    <select id="member-status" class="w-full px-3 py-2 text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-600">
                        <option value="Ativo">Ativo</option>
                        <option value="Inativo">Inativo</option>
                        <option value="Afastado">Afastado</option>
                    </select>
                    <div class="md:col-span-2">
                        <label for="member-image-file" class="text-sm font-medium text-gray-400">Imagem (Upload)</label>
                        <input type="file" id="member-image-file" class="w-full mt-1 text-sm text-gray-300 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-600">
                    </div>
                </div>
                 <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-member-modal" class="px-4 py-2 font-semibold text-gray-200 transition-colors bg-slate-600 rounded-md hover:bg-slate-700">Cancelar</button>
                    <button type="submit" class="px-4 py-2 font-semibold text-white transition-colors bg-red-700 rounded-md hover:bg-red-800">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="post-modal" class="fixed inset-0 z-30 flex items-center justify-center hidden p-4 bg-black bg-opacity-75">
        <div class="w-full max-w-lg p-6 overflow-y-auto rounded-lg shadow-xl max-h-screen glassmorphism">
            <h3 class="mb-4 text-xl font-semibold text-blue-400">Nova Postagem Administrativa</h3>
            <form id="post-form" class="space-y-4">
                 <select id="post-member-id" class="w-full px-3 py-2 text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></select>
                 <select id="post-type" class="w-full px-3 py-2 text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="Promoção">Promoção</option>
                    <option value="Rebaixamento">Rebaixamento</option>
                    <option value="Punição">Punição</option>
                    <option value="Exoneração">Exoneração</option>
                    <option value="Demissão">Demissão</option>
                    <option value="Medalha">Medalha</option>
                    <option value="Gratificação">Gratificação</option>
                 </select>
                 <div id="rank-change-fields" class="hidden grid-cols-1 gap-4 md:grid-cols-2">
                    <div>
                        <label class="text-sm font-medium text-gray-400">Cargo Anterior</label>
                        <select id="post-previous-rank" class="w-full px-3 py-2 mt-1 text-gray-200 bg-slate-800 border border-slate-700 rounded-md cursor-not-allowed" disabled></select>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-400">Cargo Novo</label>
                        <select id="post-new-rank" class="w-full px-3 py-2 mt-1 text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></select>
                    </div>
                 </div>
                 <textarea id="post-content" rows="5" placeholder="Motivo/Descrição da postagem..." class="w-full px-3 py-2 text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                 <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-post-modal" class="px-4 py-2 font-semibold text-gray-200 transition-colors bg-slate-600 rounded-md hover:bg-slate-700">Cancelar</button>
                    <button type="submit" class="px-4 py-2 font-semibold text-white transition-colors bg-blue-600 rounded-md hover:bg-blue-700">Publicar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 z-40 flex items-center justify-center hidden p-4 bg-black bg-opacity-75">
        <div class="w-full max-w-sm p-6 rounded-lg shadow-xl glassmorphism">
            <h3 id="confirmation-title" class="mb-2 text-lg font-semibold text-white"></h3>
            <p id="confirmation-message" class="mb-6 text-sm text-gray-300"></p>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-confirmation" class="px-4 py-2 font-semibold text-gray-200 transition-colors bg-slate-600 rounded-md hover:bg-slate-700">Cancelar</button>
                <button type="button" id="confirm-action" class="px-4 py-2 font-semibold text-white transition-colors bg-red-700 rounded-md hover:bg-red-800">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- CONFIGURAÇÃO DO SUPABASE ---
        const SUPABASE_URL = 'https://dncbnpzzsjqwyiecjlue.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuY2JucHp6c2pxd3lpZWNqbHVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4OTg0MzMsImV4cCI6MjA3MzQ3NDQzM30.8Mb0qVr6hbzbTcwy6pAZyDRdFDofXRZXwJmUWLZEgeY';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DADOS GLOBAIS ---
        let userProfile = null;
        let membersSubscription = null;
        let postsSubscription = null;
        
        const rankHierarchy = {
            '• Alto escalão': ['『CMD』Comandante', '『S-CMD』Sub-Comandante', '『CEL』Coronel'],
            '• Oficial': ['『TEN-C』Tenente Coronel', '『MAJ』Major', '『CAP』Capitão', '『1 TEN』1° Tenente', '『2 TEN』2° Tenente'],
            '• Aluno Oficial': ['『ASP』Aspirante a Oficial', '『CDT』Cadete', '『AOF』Aluno Oficial'],
            '• Praça': ['『S-TEN』Subtenente', '『1 SGT』1° Sargento', '『2 SGT』2° Sargento', '『3 SGT』3° Sargento', '『CB』Cabo', '『1 SD』Soldado 1º Classe', '『2 SD』Soldado 2º Classe', '『REC』Recruta']
        };

        function populateRankSelect(selectElement, selectedValue = '') {
            selectElement.innerHTML = `<option value="">Selecione o Cargo</option>`;
            for (const group in rankHierarchy) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group;
                rankHierarchy[group].forEach(rank => {
                    const option = document.createElement('option');
                    option.value = rank;
                    option.textContent = rank;
                    if (rank === selectedValue) {
                        option.selected = true;
                    }
                    optgroup.appendChild(option);
                });
                selectElement.appendChild(optgroup);
            }
        }

        // --- LÓGICA DE AUTENTICAÇÃO E UI ---
        
        async function fetchUserProfile(user) {
            if (!user) { userProfile = null; return; }
            const { data, error } = await db.from('profiles').select('*').eq('id', user.id).single();
            userProfile = error ? null : data;
        }

        async function setupAuthUI(session) {
            const user = session?.user;
            await fetchUserProfile(user);

            const authArea = document.getElementById('auth-area');
            if (user) {
                const divisionLabel = userProfile?.division ? `(${userProfile.division})` : '';
                const roleName = userProfile?.role.replace('_', ' ') || 'integrante';
                authArea.innerHTML = `
                    <div class="text-right">
                        <span class="text-sm text-gray-300">Bem-vindo, ${user.email.split('@')[0]}</span>
                        <span class="text-xs text-red-400 block capitalize">${roleName} ${divisionLabel}</span>
                    </div>
                    <button id="logout-button" class="flex items-center gap-2 px-3 py-1 text-sm text-white transition-colors bg-red-600 rounded-md hover:bg-red-700"><i data-lucide="log-out" class="w-4 h-4"></i> Sair</button>
                `;
                authArea.querySelector('#logout-button').addEventListener('click', async () => await db.auth.signOut());
            } else {
                authArea.innerHTML = `
                    <div class="relative">
                        <form id="login-form" class="flex items-center gap-2">
                             <input type="email" id="email" placeholder="Email" class="w-32 px-2 py-1 text-sm text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-1 focus:ring-red-600">
                             <input type="password" id="password" placeholder="Senha" class="w-32 px-2 py-1 text-sm text-gray-200 bg-slate-900 border border-slate-700 rounded-md focus:outline-none focus:ring-1 focus:ring-red-600">
                             <button type="submit" id="login-button" class="flex justify-center items-center px-3 py-1 text-sm font-semibold text-white transition-colors bg-red-700 rounded-md hover:bg-red-800 w-20">Entrar</button>
                        </form>
                        <p id="login-error" class="absolute -bottom-5 left-0 text-xs text-red-400 w-full"></p>
                    </div>
                `;
                authArea.querySelector('#login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const loginButton = document.getElementById('login-button');
                    const loginErrorEl = document.getElementById('login-error');
                    
                    loginErrorEl.textContent = '';
                    loginButton.disabled = true;
                    loginButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 mx-auto animate-spin"></i>`;
                    lucide.createIcons();

                    const { error } = await db.auth.signInWithPassword({ email: e.target.email.value, password: e.target.password.value });
                    if (error) {
                        loginErrorEl.textContent = 'Email ou senha inválidos.';
                        loginButton.disabled = false;
                        loginButton.innerHTML = 'Entrar';
                    }
                });
            }
            updateUIVisibility();
            lucide.createIcons();
        }
        
        db.auth.onAuthStateChange((event, session) => setupAuthUI(session));

        function updateUIVisibility() {
            const role = userProfile?.role;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = (role === 'admin' || role === 'admin_chefe') ? 'flex' : 'none');
            document.querySelectorAll('.editor-only').forEach(el => el.style.display = (role === 'admin' || role === 'admin_chefe' || role === 'comandante') ? 'flex' : 'none');
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        
        async function getMembers() {
            const { data: members, error } = await db.from('members').select('*').order('name');
            const membersGrid = document.getElementById('members-grid');
            document.getElementById('loader').style.display = 'none';

            if (error) {
                membersGrid.innerHTML = `<p class="col-span-full text-center text-red-400">Erro ao carregar dados.</p>`;
                return;
            }
            if (!members || members.length === 0) {
                membersGrid.innerHTML = `<p class="col-span-full text-center text-gray-400">Nenhum integrante encontrado.</p>`;
                return;
            }
            membersGrid.innerHTML = members.map(member => {
                const statusColor = member.status === 'Ativo' ? 'bg-green-500' : (member.status === 'Inativo' ? 'bg-red-500' : 'bg-yellow-500');
                const initial = member.name ? member.name[0] : '?';
                return `
                    <div class="p-4 transition-transform transform rounded-lg cursor-pointer glassmorphism hover:-translate-y-1" data-member-id="${member.id}">
                        <div class="flex flex-col items-center text-center">
                            <img src="${member.image_url || ''}" onerror="this.onerror=null; this.src='https://placehold.co/64x110/1a2533/ffffff?text=${initial}';" alt="Avatar de ${member.name}" class="object-cover w-16 h-24 mb-3">
                            <h4 class="font-semibold text-white">${member.name}</h4>
                            <p class="text-sm text-red-500">${member.rank}</p>
                            <div class="flex items-center gap-2 mt-2 text-xs text-gray-400">
                                <span class="w-3 h-3 ${statusColor} rounded-full"></span>
                                ${member.status}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.querySelectorAll('[data-member-id]').forEach(card => card.addEventListener('click', (e) => renderProfile(e.currentTarget.dataset.memberId)));
        }

        async function renderProfile(memberId) {
            const profileView = document.getElementById('profile-view');
            showProfileView();
            profileView.innerHTML = `<div class="flex justify-center items-center py-10"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-red-600"></i></div>`;
            lucide.createIcons();

            const { data: member, error } = await db.from('members').select('*').eq('id', memberId).single();
            if (error || !member) {
                showDashboard();
                return;
            }
            
            const statusColor = member.status === 'Ativo' ? 'text-green-400' : (member.status === 'Inativo' ? 'text-red-400' : 'text-yellow-400');
            const statusBgColor = member.status === 'Ativo' ? 'bg-green-500/20' : (member.status === 'Inativo' ? 'bg-red-500/20' : 'bg-yellow-500/20');
            const initial = member.name ? member.name[0] : '?';
            const canEdit = userProfile && (userProfile.role === 'admin' || userProfile.role === 'admin_chefe' || (userProfile.role === 'comandante' && userProfile.division === member.division));

            profileView.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <button id="back-to-dashboard" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-200 transition-colors bg-slate-700 rounded-md hover:bg-slate-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar</button>
                    ${canEdit ? `
                    <div class="flex items-center gap-2">
                        <button class="edit-member-button flex items-center gap-2 px-3 py-1 text-sm text-white transition-colors bg-blue-600 rounded-md hover:bg-blue-700" data-edit-id="${member.id}"><i data-lucide="edit" class="w-4 h-4"></i> Editar</button>
                        <button class="delete-member-button flex items-center gap-2 px-3 py-1 text-sm text-white transition-colors bg-red-700 rounded-md hover:bg-red-800" data-delete-id="${member.id}"><i data-lucide="trash-2" class="w-4 h-4"></i> Excluir</button>
                    </div>` : ''}
                </div>
                <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
                    <div class="p-6 rounded-lg lg:col-span-1 glassmorphism">
                        <h3 class="pb-3 mb-4 text-lg font-semibold text-center text-red-500 border-b border-slate-700">Identidade - ${member.division || 'N/A'}</h3>
                        <div class="flex justify-center"><img src="${member.image_url || ''}" onerror="this.onerror=null; this.src='https://placehold.co/128x220/1a2533/ffffff?text=${initial}';" alt="Avatar de ${member.name}" class="object-cover h-48 w-32"></div>
                        <div class="mt-6 space-y-3">
                            <div class="flex justify-between text-sm"><span class="font-semibold text-gray-400">Nick:</span><span class="font-medium text-white">${member.name}</span></div>
                            <div class="flex items-center justify-between text-sm"><span class="font-semibold text-gray-400">Estado:</span><span class="px-2 py-0.5 text-xs font-semibold rounded-full ${statusColor} ${statusBgColor}">${member.status}</span></div>
                            <div class="flex justify-between text-sm"><span class="font-semibold text-gray-400">Patente/Cargo:</span><span class="font-medium text-white">${member.rank}</span></div>
                            <div class="flex justify-between text-sm"><span class="font-semibold text-gray-400">Dias no posto:</span><span class="font-medium text-white">${calculateDays(member.join_date)}</span></div>
                            <div class="flex justify-between text-sm"><span class="font-semibold text-gray-400">TAG:</span><span class="font-medium text-white">${member.tag || 'N/A'}</span></div>
                            <div class="flex justify-between text-sm"><span class="font-semibold text-gray-400">Especialização:</span><span class="font-medium text-white">${member.specialization || 'Nenhuma'}</span></div>
                        </div>
                    </div>
                    <div class="p-6 rounded-lg lg:col-span-2 glassmorphism">
                         <h3 class="pb-3 mb-6 text-lg font-semibold border-b text-red-500 border-slate-700">Linha do Tempo</h3>
                         <div id="timeline-content" class="relative space-y-8"></div>
                    </div>
                </div>
            `;
            document.getElementById('back-to-dashboard').addEventListener('click', () => showDashboard());
            profileView.querySelector('.edit-member-button')?.addEventListener('click', (e) => openMemberModal(e.currentTarget.dataset.editId));
            profileView.querySelector('.delete-member-button')?.addEventListener('click', (e) => deleteMember(e.currentTarget.dataset.deleteId, member.name));
            
            renderPosts(memberId);
            if (postsSubscription) postsSubscription.unsubscribe();
            postsSubscription = db.channel(`posts_for_${memberId}`).on('postgres_changes', { event: '*', schema: 'public', table: 'posts', filter: `member_id=eq.${memberId}` }, payload => renderPosts(memberId)).subscribe();
            
            updateUIVisibility();
            lucide.createIcons();
        }
        
        async function renderPosts(memberId) {
            const timelineContent = document.getElementById('timeline-content');
            const {data: posts, error} = await db.from('posts').select('*').eq('member_id', memberId).order('date', { ascending: false });

            if (error || !posts) {
                timelineContent.innerHTML = `<p class="text-gray-400">Não foi possível carregar as postagens.</p>`;
                return;
            }
            if(posts.length === 0) {
                timelineContent.innerHTML = `<p class="text-gray-400">Nenhuma postagem encontrada.</p>`;
                return;
            }

            const postTypeColors = {'Promoção':'text-green-400','Punição':'text-red-400','Rebaixamento':'text-orange-400','Exoneração':'text-gray-400','Demissão':'text-red-600','Medalha':'text-amber-400','Gratificação':'text-sky-400'};
            timelineContent.innerHTML = posts.map(post => {
                const postDate = new Date(post.date).toLocaleDateString('pt-BR');
                let rankChangeInfo = '';
                if (post.previous_rank && post.new_rank) {
                    rankChangeInfo = `
                        <div class="mt-2 text-sm text-gray-400 bg-slate-800 p-2 rounded-md">
                            <span class="font-semibold">De:</span> ${post.previous_rank} &rarr; <span class="font-semibold">Para:</span> ${post.new_rank}
                        </div>
                    `;
                }
                return `
                    <div class="relative pl-8 timeline-item">
                        <div class="timeline-line"></div>
                        <p class="text-sm text-gray-400">${postDate} por, ${post.author}</p>
                        <h4 class="mt-1 text-lg font-semibold ${postTypeColors[post.type] || 'text-white'}">${post.type}</h4>
                        <p class="mt-2 text-sm leading-relaxed text-gray-300 whitespace-pre-wrap">${post.content}</p>
                        ${rankChangeInfo}
                    </div>
                `;
            }).join('');
        }


        // --- LÓGICA DE NAVEGAÇÃO ---
        function showDashboard() {
            if(postsSubscription) { postsSubscription.unsubscribe(); postsSubscription = null; }
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            
            const membersGrid = document.getElementById('members-grid');
            membersGrid.innerHTML = ''; 
            document.getElementById('loader').style.display = 'flex';
            
            getMembers();
            
            if (membersSubscription) { membersSubscription.unsubscribe(); }
            membersSubscription = db.channel('public:members').on('postgres_changes', { event: '*', schema: 'public', table: 'members' }, () => getMembers()).subscribe();
        }

        function showProfileView() {
            if(membersSubscription) { membersSubscription.unsubscribe(); membersSubscription = null; }
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('profile-view').classList.remove('hidden');
        }
        
        // --- MODAIS E FORMULÁRIOS ---
        const memberModal = document.getElementById('member-modal');
        const postModal = document.getElementById('post-modal');
        const confirmationModal = document.getElementById('confirmation-modal');

        async function openMemberModal(memberId = null) {
            const form = document.getElementById('member-form');
            form.reset();
            populateRankSelect(document.getElementById('member-rank'));
            document.getElementById('member-id').value = '';
            if (memberId) {
                const { data: member } = await db.from('members').select('*').eq('id', memberId).single();
                if (member) {
                    document.getElementById('member-modal-title').textContent = 'Editar Integrante';
                    document.getElementById('member-id').value = memberId;
                    document.getElementById('member-name').value = member.name;
                    populateRankSelect(document.getElementById('member-rank'), member.rank);
                    document.getElementById('member-tag').value = member.tag;
                    document.getElementById('member-division').value = member.division;
                    document.getElementById('member-specialization').value = member.specialization;
                    document.getElementById('member-status').value = member.status;
                }
            } else {
                document.getElementById('member-modal-title').textContent = 'Adicionar Novo Integrante';
            }
            memberModal.classList.remove('hidden');
        }
        
        document.getElementById('member-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('member-id').value;
            const file = document.getElementById('member-image-file').files[0];
            let imageUrl = null;

            if(file) {
                const filePath = `public/${Date.now()}-${file.name}`;
                const { data: uploadData, error: uploadError } = await db.storage.from('avatars').upload(filePath, file);
                if (uploadError) return console.error("Erro no upload da imagem:", uploadError.message);
                const { data } = db.storage.from('avatars').getPublicUrl(uploadData.path);
                imageUrl = data.publicUrl;
            }
            
            const memberData = {
                name: document.getElementById('member-name').value,
                rank: document.getElementById('member-rank').value,
                division: document.getElementById('member-division').value,
                tag: document.getElementById('member-tag').value,
                specialization: document.getElementById('member-specialization').value,
                status: document.getElementById('member-status').value,
            };
            if(imageUrl) memberData.image_url = imageUrl;

            let error, memberId = id;
            if (id) { 
                ({ error } = await db.from('members').update(memberData).eq('id', id));
                if (error) return console.error("Erro ao salvar integrante:", error.message);
                memberModal.classList.add('hidden');
                if (document.getElementById('dashboard-view').classList.contains('hidden')) {
                    renderProfile(memberId);
                }
            } else { 
                const { data, error: insertError } = await db.from('members').insert(memberData).select().single();
                if (insertError) return console.error("Erro ao salvar integrante:", insertError.message);
                memberModal.classList.add('hidden');
                showDashboard(); 
            }
        });

        async function deleteMember(memberId, memberName) {
            openConfirmationModal(
                `Deseja realmente excluir ${memberName}?`,
                "Todos os posts e dados associados serão perdidos permanentemente.",
                async () => {
                    const { data: memberToDelete } = await db.from('members').select('image_url').eq('id', memberId).single();

                    const { error: deleteError } = await db.from('members').delete().eq('id', memberId);
                    if (deleteError) return console.error("Erro ao excluir membro:", deleteError.message);

                    if (memberToDelete && memberToDelete.image_url) {
                        try {
                            const pathToDelete = new URL(memberToDelete.image_url).pathname.split('/public/avatars/')[1];
                            if(pathToDelete) await db.storage.from('avatars').remove([`public/${pathToDelete}`]);
                        } catch(e) { console.error("Não foi possível remover imagem do storage:", e.message); }
                    }
                    
                    if (!document.getElementById('profile-view').classList.contains('hidden')) {
                        showDashboard();
                    }
                }
            );
        }
        
        const postTypeSelect = document.getElementById('post-type');
        const rankChangeFields = document.getElementById('rank-change-fields');

        postTypeSelect.addEventListener('change', () => {
            const selectedType = postTypeSelect.value;
            if (selectedType === 'Promoção' || selectedType === 'Rebaixamento') {
                rankChangeFields.classList.remove('hidden');
                rankChangeFields.classList.add('grid');
            } else {
                rankChangeFields.classList.add('hidden');
                rankChangeFields.classList.remove('grid');
            }
        });

        document.getElementById('post-member-id').addEventListener('change', async (e) => {
            const memberId = e.target.value;
            const previousRankSelect = document.getElementById('post-previous-rank');
            if (!memberId) {
                populateRankSelect(previousRankSelect);
                return;
            };
            const { data: member } = await db.from('members').select('rank').eq('id', memberId).single();
            if (member) {
                populateRankSelect(previousRankSelect, member.rank);
            }
        });


        async function openPostModal() {
            document.getElementById('post-form').reset();
            rankChangeFields.classList.add('hidden');
            rankChangeFields.classList.remove('grid');

            populateRankSelect(document.getElementById('post-previous-rank'));
            populateRankSelect(document.getElementById('post-new-rank'));
            
            const select = document.getElementById('post-member-id');
            let query = db.from('members').select('id, name');

            if (userProfile && userProfile.role === 'comandante') {
                query = query.eq('division', userProfile.division);
            }
            const { data: members } = await query.order('name');
            
            select.innerHTML = '<option value="">Selecione um integrante...</option>';
            if (members) {
                members.forEach(member => select.innerHTML += `<option value="${member.id}">${member.name}</option>`);
            }
            postModal.classList.remove('hidden');
        }

        document.getElementById('post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { data: { user } } = await db.auth.getUser();
            const memberId = document.getElementById('post-member-id').value;
            const postType = document.getElementById('post-type').value;

            const postData = {
                member_id: memberId,
                type: postType,
                content: document.getElementById('post-content').value,
                author: user.email.split('@')[0] || 'Admin'
            };

            if (postType === 'Promoção' || postType === 'Rebaixamento') {
                const newRank = document.getElementById('post-new-rank').value;
                postData.previous_rank = document.getElementById('post-previous-rank').value;
                postData.new_rank = newRank;

                await db.from('posts').insert(postData);
                await db.from('members').update({ rank: newRank }).eq('id', memberId);

            } else {
                await db.from('posts').insert(postData);
            }
            
            postModal.classList.add('hidden');
        });

        function openConfirmationModal(title, message, onConfirm) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            
            const confirmBtn = document.getElementById('confirm-action');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => { onConfirm(); confirmationModal.classList.add('hidden'); });
            confirmationModal.classList.remove('hidden');
        }

        // --- Event Listeners ---
        document.getElementById('add-member-button').addEventListener('click', () => openMemberModal());
        document.getElementById('cancel-member-modal').addEventListener('click', () => memberModal.classList.add('hidden'));
        document.getElementById('add-post-button').addEventListener('click', openPostModal);
        document.getElementById('cancel-post-modal').addEventListener('click', () => postModal.classList.add('hidden'));
        document.getElementById('cancel-confirmation').addEventListener('click', () => confirmationModal.classList.add('hidden'));
        document.getElementById('home-button').addEventListener('click', () => showDashboard());

        // --- Funções Utilitárias ---
        function calculateDays(joinDateStr) {
            if (!joinDateStr) return 'N/A';
            const startDate = new Date(joinDateStr);
            const today = new Date();
            const diffTime = Math.abs(today - startDate);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // --- Inicialização ---
        async function initializeApp() {
            lucide.createIcons();
            const { data: { session } } = await db.auth.getSession();
            await setupAuthUI(session);
            showDashboard();
            document.getElementById('home-button').addEventListener('click', () => showDashboard());
        }

        initializeApp();
    </script>
</body>
</html>

